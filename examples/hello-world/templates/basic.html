<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>{{ name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous" />
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
    integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@patternfly/patternfly/patternfly.css" crossorigin="anonymous">
</head>

<body>




  <div class="container">
    <h1 class="mb-4">{{ name }}</h1>
    <div class="row">
      <div class="col-6">
        <div id="content"></div>
      </div>
      <div class="col-6">
        <form id="form" class="row">
          {% for param in parameters %}
          <div class="mb-3 col-6">
            <label for="{{ param.name }}" class="form-label">{{ param.name }}</label>
            {% if param.type == 'text' %}
            <input type="text" class="form-control" id="{{ param.name }}" name="{{ param.name }}"
              value="{{ param.default }}" />
            {% elif param.type == 'number' %}
            <input type="number" class="form-control" id="{{ param.name }}" name="{{ param.name }}"
              value="{{ param.default }}" />
            {% elif param.type == 'single-choice' %}
            <select class="form-select" id="{{ param.name }}" name="{{ param.name }}">
              {% for choice in param.choices %}
              <option value="{{ choice }}" {% if choice==param.default %}selected{% endif %}>{{ choice }}</option>
              {% endfor %}
            </select>
            {% elif param.type == 'multi-choice' %}
            {% set defaults = param.default if param.default is iterable else [param.default] %}
            <select name="{{ param.name }}" id="{{ param.name }}" class="form-select" multiple>

              {% for choice in param.choices %}
              <option {% if choice in defaults %}selected{% endif %} value="{{ choice }}">{{ choice }}</option>
              {% endfor %}
            </select>

            {% endif %}
          </div>
          {% endfor %}
          <button type="submit" class="btn btn-primary">Run</button>
        </form>
        <hr>
        <nav class="navbar navbar-light bg-light">
          <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Log</span>
          </div>
        </nav>




        <div class="pf-c-log-viewer" style="--pf-c-log-viewer__index--Width: 75px;" tabindex="0" role="region"
          aria-label="Basic log viewer">
          <div class="pf-c-log-viewer__main" role="log">
            <div class="pf-c-log-viewer__scroll-container" tabindex="0">
              <div class="pf-c-log-viewer__list" style="--pf-c-log-viewer__list--Height: 301080px;">

              </div>
            </div>
          </div>
        </div>




        <div id="log" class="hljs language-console text-break"></div>










      </div>
    </div>



  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="
https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js
"></script>
  <script>
    $(() => {
      marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: (code, lang) => hljs.highlightAuto(code).value,
        langPrefix: 'hljs language-',
      });

      const logViewer = $('.pf-c-log-viewer');
      const logList = logViewer.find('.pf-c-log-viewer__list');

      const addLogItem = text => {
        const lastItem = logList.children().last();
        const index = lastItem ? parseInt(lastItem.find('.pf-c-log-viewer__index').text(), 10) + 1 : 1;
        const newItem = $(`<div class="pf-c-log-viewer__list-item" style="top: ${index * 20}px">
      <span class="pf-c-log-viewer__index">${index}</span>
      <span class="pf-c-log-viewer__text">${text}</span>
    </div>`);
        logList.append(newItem);
      };
      var objectConstructor = ({}).constructor;

      function stringifyIfNeeded(value) {
        if (value.constructor === objectConstructor) {
          return JSON.stringify(value);
        } else {
          return value
        }
      }


      $('#content').html(marked.parse(`{{ markdown | safe | replace('`','\`') }}`));

      const empty = () => $('.pf-c-log-viewer__list-item').remove();

      const res = () => $.get('/res').done(data => addLogItem(stringifyIfNeeded(data))).fail(error => addLogItem(error.responseText));

      const log = () => $.get('/log').done(data => (addLogItem(stringifyIfNeeded(data)), res())).fail(error => (addLogItem(error.responseText), setTimeout(log, 500)));

      $('#form').submit(e => {
        e.preventDefault();
        empty();
        const result = $('#form').serializeArray().reduce((acc, { name, value }) => ((acc[name] = acc[name] ? `${acc[name]},${value}` : value), acc), {});
        $.post('/run', result).done(data => (addLogItem(stringifyIfNeeded(data)), log())).fail(error => (addLogItem(error.responseText), null));
      });
    });


  </script>
</body>

</html>