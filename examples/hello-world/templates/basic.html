<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.4.min.js"
      integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
<div class="container">
  <h1 class="mb-4">{{ name }}</h1>
  <p class="mb-4">{{ markdown }}</p>
  <form id="form">
    {% for param in parameters %}
    <div class="mb-3">
      <label for="{{ param.name }}" class="form-label">{{ param.name }}</label>
      {% if param.type == 'text' %}
      <input type="text" class="form-control" id="{{ param.name }}" name="{{ param.name }}" value="{{ param.default }}" />
      {% elif param.type == 'number' %}
      <input type="number" class="form-control" id="{{ param.name }}" name="{{ param.name }}" value="{{ param.default }}" />
      {% elif param.type == 'single-choice' %}
      <select class="form-select" id="{{ param.name }}" name="{{ param.name }}">
        {% for choice in param.choices %}
        <option value="{{ choice }}" {% if choice == param.default %}selected{% endif %}>{{ choice }}</option>
        {% endfor %}
      </select>
      {% elif param.type == 'multi-choice' %}
      {% set defaults = param.default if param.default is iterable else [param.default] %}
      {% for choice in param.choices %}
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="{{ param.name }}" value="{{ choice }}" id="{{ param.name }}-{{ choice }}" {% if choice in defaults %}checked{% endif %}>
        <label class="form-check-label" for="{{ param.name }}-{{ choice }}">
          {{ choice }}
        </label>
      </div>
      {% endfor %}
      {% endif %}
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
  <hr class="my-4">
  <p>Run log :</p>
  <div id="run" class="mb-4"></div>
  <p>Follow log:</p>
  <div id="log" class="mb-4"></div>
  <p>Result log:</p>
  <div id="res" class="mb-4"></div>
</div>


    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script>
		$(function() {
		const empty = () => $("#run,#log,#res").text("");

		$("#form").submit(e => {
			e.preventDefault();
			empty();
			$.post("/run", $(this).serialize())
			.done(res => ($("#run").text(JSON.stringify(res)), log()))
			.fail(error => ($("#run").text(JSON.stringify(error)), null));
		});

		const log = () =>
			$.get("/log")
			.done(log => ($("#log").append(JSON.stringify(log)), res()))
			.fail(error => ($("#log").append(error.responseText), setTimeout(log, 500)));

		const res = () =>
			$.get("/res")
			.done(log => $("#res").text(JSON.stringify(log)))
			.fail(error => $("#res").text(error.responseText));
		});
    </script>
  </body>
</html>
